<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>WebAR Photo Space</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; touch-action: none; }
        
        /* UIコンテナを最前面に配置 */
        .ui-container {
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%);
            z-index: 10000 !important; 
            display: flex; 
            gap: 15px; 
            width: 90%; 
            justify-content: center;
            pointer-events: auto !important;
        }

        button, label {
            padding: 15px 25px; 
            background: rgba(0,0,0,0.85); 
            color: white;
            border-radius: 50px; 
            border: 2px solid #fff; 
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            flex: 1;
            max-width: 200px;
            pointer-events: auto !important;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ARのキャンバスがUIを邪魔しないようにする */
        canvas.a-canvas { z-index: 1 !important; }
        .a-enter-vr { display: none; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="ui-container">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <label for="fileInput" id="fileLabel">① 写真を選ぶ</label>
        <button id="shotBtn" type="button">② 写真を撮る</button>
    </div>

    <a-scene embedded 
             arjs="sourceType: webcam; debugUIEnabled: false;" 
             renderer="logarithmicDepthBuffer: true; colorManagement: true;"
             vr-mode-ui="enabled: false"
             screenshot>
        
        <a-entity id="myCamera" camera look-controls></a-entity>
        
    </a-scene>

    <script>
const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');
const fileLabel = document.getElementById('fileLabel');
const shotBtn = document.getElementById('shotBtn');
let selectedImgUrl = null;
let canPlace = false;

// 1. 画像選択
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        if (selectedImgUrl) URL.revokeObjectURL(selectedImgUrl);
        selectedImgUrl = URL.createObjectURL(file);
        canPlace = true;
        fileLabel.innerText = "✅ 画面をタップ！";
        fileLabel.style.background = "#2e7d32";
    }
});

// 2. 配置処理（Three.jsのローダーを使用）
const addPhotoToSpace = (e) => {
    if (e.target.closest('.ui-container')) return;
    if (!selectedImgUrl || !canPlace) return;

    const cameraEl = document.getElementById('myCamera');
    const cameraObj = cameraEl.object3D;

    const position = new THREE.Vector3();
    const direction = new THREE.Vector3();
    cameraObj.getWorldPosition(position);
    cameraObj.getWorldDirection(direction);

    // a-planeを作成
    const newImage = document.createElement('a-plane');
    const distance = 2;
    const targetPos = {
        x: position.x + direction.x * -distance,
        y: position.y + direction.y * -distance,
        z: position.z + direction.z * -distance
    };
    newImage.setAttribute('position', `${targetPos.x} ${targetPos.y} ${targetPos.z}`);
    newImage.setAttribute('look-at', '#myCamera');
    newImage.setAttribute('visible', 'false'); // ロード完了まで隠す

    // シーンに追加
    scene.appendChild(newImage);

    // 【最重要】Three.jsのTextureLoaderで直接読み込む
    const loader = new THREE.TextureLoader();
    loader.load(selectedImgUrl, (texture) => {
        // 画像の比率を計算
        const imgAspect = texture.image.width / texture.image.height;
        const baseSize = 1.5;
        
        // 板のサイズを写真の比率に合わせる
        newImage.setAttribute('width', baseSize * imgAspect);
        newImage.setAttribute('height', baseSize);

        // A-Frameのメッシュに直接テクスチャを流し込む
        const mesh = newImage.getObject3D('mesh');
        mesh.material = new THREE.MeshBasicMaterial({
            map: texture,
            side: THREE.DoubleSide,
            transparent: true
        });
        
        newImage.setAttribute('visible', 'true');
    });

    canPlace = false;
    fileLabel.innerText = "① 次の写真を選ぶ";
    fileLabel.style.background = "rgba(0,0,0,0.85)";
};

window.addEventListener('mousedown', addPhotoToSpace);
window.addEventListener('touchstart', (e) => {
    if (e.touches.length > 1) return;
    addPhotoToSpace(e);
}, { passive: false });

// 3. 撮影（iOS/Android両対応の安全策）
shotBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const canvas = scene.components.screenshot.getCanvas('perspective');
    const dataURI = canvas.toDataURL('image/png');
    
    // ダウンロードを試みる
    const link = document.createElement('a');
    link.download = `ar-photo-${Date.now()}.png`;
    link.href = dataURI;
    
    // iOS Safari対策：ダウンロードがブロックされる場合は別窓で開く
    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        const newWindow = window.open();
        newWindow.document.write(`<img src="${dataURI}" style="width:100%" />`);
        newWindow.document.write('<p>画像を長押しして保存してください</p>');
    } else {
        link.click();
    }
});
    </script>
</body>
</html>