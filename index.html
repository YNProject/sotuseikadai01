<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>WebAR Photo Space</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; touch-action: none; }
        .ui-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 10000; display: flex; gap: 10px; width: 90%; justify-content: center;
        }
        button, label {
            padding: 15px; background: rgba(0,0,0,0.8); color: white;
            border-radius: 50px; border: 2px solid white; font-size: 14px; flex: 1; text-align: center;
        }
        canvas.a-canvas { z-index: 1; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="ui-container">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <label for="fileInput" id="fileLabel">① 写真を選ぶ</label>
        <button id="shotBtn" type="button">② 写真を撮る</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false" screenshot>
        <a-entity id="myCamera" camera look-controls></a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');
const fileLabel = document.getElementById('fileLabel');
let selectedImgUrl = null;
let canPlace = false;

// 1. 画像選択（Canvasに描画してセキュリティ制限を回避）
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                // Canvasを作成して画像を転写
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                // CanvasをデータURLに変換（これでセキュリティ制限を抜ける）
                selectedImgUrl = canvas.toDataURL('image/png');
                canPlace = true;
                fileLabel.innerText = "✅ 画面をタップ！";
                fileLabel.style.background = "#2e7d32";
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// 2. 配置処理
const addPhotoToSpace = (e) => {
    if (e.target.closest('.ui-container')) return;
    if (!selectedImgUrl || !canPlace) return;

    const cameraEl = document.getElementById('myCamera');
    const cameraObj = cameraEl.object3D;

    const position = new THREE.Vector3();
    const direction = new THREE.Vector3();
    cameraObj.getWorldPosition(position);
    cameraObj.getWorldDirection(direction);

    const newImage = document.createElement('a-plane');
    // 初期状態は少し透明な板にする
    newImage.setAttribute('material', 'side: double; shader: flat; transparent: true; opacity: 0.8;');
    
    const distance = 2;
    newImage.setAttribute('position', {
        x: position.x + direction.x * -distance,
        y: position.y + direction.y * -distance,
        z: position.z + direction.z * -distance
    });
    newImage.setAttribute('look-at', '#myCamera');

    // テクスチャを直接適用
    const loader = new THREE.TextureLoader();
    loader.load(selectedImgUrl, (texture) => {
        const mesh = newImage.getObject3D('mesh');
        mesh.material.map = texture;
        mesh.material.opacity = 1.0;
        mesh.material.needsUpdate = true;
        
        // 比率調整
        const aspect = texture.image.width / texture.image.height;
        newImage.setAttribute('width', 1.5 * aspect);
        newImage.setAttribute('height', 1.5);
    });

    scene.appendChild(newImage);

    canPlace = false;
    fileLabel.innerText = "① 次の写真を選ぶ";
    fileLabel.style.background = "rgba(0,0,0,0.8)";
};

window.addEventListener('mousedown', addPhotoToSpace);
window.addEventListener('touchstart', addPhotoToSpace);

// 3. 撮影機能（変更なし）
document.getElementById('shotBtn').addEventListener('click', () => {
    const canvas = scene.components.screenshot.getCanvas('perspective');
    const dataURI = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = 'ar-photo.png';
    link.href = dataURI;
    link.click();
    if(/iPhone|iPad/i.test(navigator.userAgent)) { window.open(dataURI, '_blank'); }
});
    </script>
</body>
</html>