<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>WebAR Photo Space</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; touch-action: none; }
        .ui-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 10000; display: flex; gap: 10px; width: 90%; justify-content: center;
        }
        button, label {
            padding: 15px; background: rgba(0,0,0,0.8); color: white;
            border-radius: 50px; border: 2px solid white; font-size: 14px; flex: 1; text-align: center;
        }
        canvas.a-canvas { z-index: 1; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="ui-container">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <label for="fileInput" id="fileLabel">① 写真を選ぶ</label>
        <button id="shotBtn" type="button">② 写真を撮る</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false" screenshot>
        <a-entity id="myCamera" camera look-controls></a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        let selectedImgUrl = null;
        let canPlace = false;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (selectedImgUrl) URL.revokeObjectURL(selectedImgUrl);
                selectedImgUrl = URL.createObjectURL(file);
                canPlace = true;
                fileLabel.innerText = "✅ 画面をタップ！";
                fileLabel.style.background = "#2e7d32";
            }
        });

        const addPhotoToSpace = (e) => {
            if (e.target.closest('.ui-container')) return;
            if (!selectedImgUrl || !canPlace) return;

            const cameraEl = document.getElementById('myCamera');
            const cameraObj = cameraEl.object3D;

            const position = new THREE.Vector3();
            const direction = new THREE.Vector3();
            cameraObj.getWorldPosition(position);
            cameraObj.getWorldDirection(direction);

            // まず「赤い仮の板」を作成（これで配置されたかすぐわかる）
            const newImage = document.createElement('a-plane');
            newImage.setAttribute('color', 'red'); // 読み込み前は赤色
            newImage.setAttribute('width', '1.5');
            newImage.setAttribute('height', '1.5');
            newImage.setAttribute('look-at', '#myCamera');
            newImage.setAttribute('material', 'side: double; shader: flat;');

            const distance = 2;
            newImage.setAttribute('position', {
                x: position.x + direction.x * -distance,
                y: position.y + direction.y * -distance,
                z: position.z + direction.z * -distance
            });

            scene.appendChild(newImage);

            // 配置直後にテクスチャの読み込みを開始
            const loader = new THREE.TextureLoader();
            loader.load(selectedImgUrl, (texture) => {
                // 読み込めたら色を消して画像をセット
                const mesh = newImage.getObject3D('mesh');
                mesh.material.map = texture;
                mesh.material.color.set(0xffffff); // 赤色を解除
                mesh.material.needsUpdate = true;
                
                // アスペクト比調整
                const aspect = texture.image.width / texture.image.height;
                newImage.setAttribute('width', 1.5 * aspect);
            }, undefined, (err) => {
                console.error("Load Error:", err);
                alert("画像の読み込みに失敗しました。");
            });

            canPlace = false;
            fileLabel.innerText = "① 次の写真を選ぶ";
            fileLabel.style.background = "rgba(0,0,0,0.8)";
        };

        window.addEventListener('mousedown', addPhotoToSpace);
        window.addEventListener('touchstart', addPhotoToSpace);

        // 撮影機能
        document.getElementById('shotBtn').addEventListener('click', () => {
            const canvas = scene.components.screenshot.getCanvas('perspective');
            const dataURI = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'ar-photo.png';
            link.href = dataURI;
            link.click();
            // iOS用
            if(/iPhone|iPad/i.test(navigator.userAgent)) {
                window.open(dataURI, '_blank');
            }
        });
    </script>
</body>
</html>