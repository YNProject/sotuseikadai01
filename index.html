<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebAR Photo Space</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        .ui-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; gap: 10px; width: 90%; justify-content: center;
        }
        button, label {
            padding: 15px; background: rgba(0,0,0,0.7); color: white;
            border-radius: 50px; border: 2px solid white; font-size: 14px;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="ui-container">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <label for="fileInput">① 写真を選ぶ</label>
        <button id="shotBtn">② 写真を撮る</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <a-entity id="myCamera" camera look-controls></a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const fileInput = document.getElementById('fileInput');
        let selectedImgUrl = null;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedImgUrl = URL.createObjectURL(file);
                document.querySelector('label').innerText = "✅ 画面をタップ！";
            }
        });

        const addPhotoToSpace = (e) => {
            if (!selectedImgUrl) return;
            if (e.target.closest('.ui-container')) return;

            const cameraEl = document.getElementById('myCamera');
            const cameraObj = cameraEl.object3D;

            const position = new THREE.Vector3();
            const direction = new THREE.Vector3();
            
            cameraObj.getWorldPosition(position);
            cameraObj.getWorldDirection(direction);

            const newImage = document.createElement('a-image');
            newImage.setAttribute('src', selectedImgUrl);

            // カメラの向いている方向に1.5m先
            const distance = 1.5; 
            const targetPos = {
                x: position.x + direction.x * -distance,
                y: position.y + direction.y * -distance,
                z: position.z + direction.z * -distance
            };

            newImage.setAttribute('position', `${targetPos.x} ${targetPos.y} ${targetPos.z}`);
            
            // ★Look-atをカメラのIDに向ける
            newImage.setAttribute('look-at', '#myCamera');
            newImage.setAttribute('scale', '1 1 1');

            scene.appendChild(newImage);
        };

        // タップとクリック両方に対応
        window.addEventListener('touchstart', addPhotoToSpace);
        window.addEventListener('mousedown', addPhotoToSpace);

        // カメラ撮影機能
        document.getElementById('shotBtn').addEventListener('click', () => {
            const canvas = scene.components.screenshot.getCanvas('perspective');
            const link = document.createElement('a');
            link.download = `ar-photo-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    </script>
</body>
</html>