<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebAR Photo Space</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        .ui-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; gap: 10px; width: 90%; justify-content: center;
        }
        button, label {
            padding: 15px; background: rgba(0,0,0,0.7); color: white;
            border-radius: 50px; border: 2px solid white; font-size: 14px;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="ui-container">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <label for="fileInput">① 写真を選ぶ</label>
        <button id="shotBtn">② 写真を撮る</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <a-entity id="myCamera" camera look-controls></a-entity>
    </a-scene>

    <script>
const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');
let selectedImgUrl = null;
let canPlace = false;

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        if (selectedImgUrl) URL.revokeObjectURL(selectedImgUrl);
        selectedImgUrl = URL.createObjectURL(file);
        canPlace = true;
        document.querySelector('label').innerText = "✅ 画面をタップ！";
        
        // 【重要】配置前にブラウザに画像を一度ロードさせておく（真っ白対策）
        const dummyImg = new Image();
        dummyImg.src = selectedImgUrl;
    }
});

const addPhotoToSpace = (e) => {
    if (!selectedImgUrl || !canPlace) return;
    if (e.target.closest('.ui-container')) return;

    const cameraEl = document.getElementById('myCamera');
    const cameraObj = cameraEl.object3D;

    const position = new THREE.Vector3();
    const direction = new THREE.Vector3();
    cameraObj.getWorldPosition(position);
    cameraObj.getWorldDirection(direction);

    // a-imageではなく、より制御しやすいa-entity + geometryで作成
    const newImage = document.createElement('a-entity');
    
    // 【修正点】material設定を詳細に行う（shaderをflatにしてライトの影響を無視）
    newImage.setAttribute('geometry', 'primitive: plane; width: 1; height: 1;');
    newImage.setAttribute('material', {
        src: selectedImgUrl,
        shader: 'flat',
        transparent: true,
        side: 'double' // 裏からも見えるように
    });

    const distance = 1.5; 
    const targetPos = {
        x: position.x + direction.x * -distance,
        y: position.y + direction.y * -distance,
        z: position.z + direction.z * -distance
    };

    newImage.setAttribute('position', `${targetPos.x} ${targetPos.y} ${targetPos.z}`);
    newImage.setAttribute('look-at', '#myCamera');

    scene.appendChild(newImage);

    canPlace = false; 
    document.querySelector('label').innerText = "① 次の写真を選ぶ";
};

// タップイベントを確実に拾う設定
window.addEventListener('mousedown', addPhotoToSpace);
window.addEventListener('touchstart', (e) => {
    if(e.touches.length > 1) return;
    addPhotoToSpace(e);
}, {passive: false});

// 撮影機能は前回のままでOK（縦横比対応版）
    </script>
</body>
</html>