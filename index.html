<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebAR Photo Space</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        .ui-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; gap: 10px; width: 90%; justify-content: center;
        }
        button, label {
            padding: 15px; background: rgba(0,0,0,0.7); color: white;
            border-radius: 50px; border: 2px solid white; font-size: 14px;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

    <div class="ui-container">
        <input type="file" id="fileInput" accept="image/*" style="display:none">
        <label for="fileInput">① 写真を選ぶ</label>
        <button id="shotBtn">② 写真を撮る</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <a-entity id="myCamera" camera look-controls></a-entity>
    </a-scene>

    <script>
const scene = document.querySelector('a-scene');
const fileInput = document.getElementById('fileInput');
let selectedImgUrl = null;
let canPlace = false; // ★配置可能かどうかを管理するフラグ

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        if (selectedImgUrl) URL.revokeObjectURL(selectedImgUrl);
        selectedImgUrl = URL.createObjectURL(file);
        
        canPlace = true; // ★写真を選んだので配置可能にする
        document.querySelector('label').innerText = "✅ タップして配置してください";
    }
});

const addPhotoToSpace = (e) => {
    // ★「写真が未選択」または「すでに配置済み」なら何もしない
    if (!selectedImgUrl || !canPlace) return;
    
    if (e.target.closest('.ui-container')) return;

    const cameraEl = document.getElementById('myCamera');
    const cameraObj = cameraEl.object3D;

    const position = new THREE.Vector3();
    const direction = new THREE.Vector3();
    cameraObj.getWorldPosition(position);
    cameraObj.getWorldDirection(direction);

    const newImage = document.createElement('a-image');
    newImage.setAttribute('material', `src: ${selectedImgUrl}; transparent: true; shader: flat;`);
    
    const distance = 1.5; 
    const targetPos = {
        x: position.x + direction.x * -distance,
        y: position.y + direction.y * -distance,
        z: position.z + direction.z * -distance
    };

    newImage.setAttribute('position', `${targetPos.x} ${targetPos.y} ${targetPos.z}`);
    newImage.setAttribute('look-at', '#myCamera');
    newImage.setAttribute('scale', '1 1 1');

    scene.appendChild(newImage);

    // ★配置したのでフラグを折る
    canPlace = false; 
    document.querySelector('label').innerText = "① 次の写真を選ぶ";
};

// 以下、イベント登録と撮影機能はそのまま
window.addEventListener('mousedown', addPhotoToSpace);
window.addEventListener('touchstart', (e) => {
    if(e.touches.length > 1) return;
    addPhotoToSpace(e);
});

document.getElementById('shotBtn').addEventListener('click', () => {
    const w = window.innerWidth;
    const h = window.innerHeight;
    const canvas = scene.components.screenshot.getCanvas('perspective');
    const outputCanvas = document.createElement('canvas');
    outputCanvas.width = w;
    outputCanvas.height = h;
    const ctx = outputCanvas.getContext('2d');
    ctx.drawImage(canvas, 0, 0, w, h);

    const link = document.createElement('a');
    link.download = `ar-photo-${Date.now()}.png`;
    link.href = outputCanvas.toDataURL('image/png');
    link.click();
});
    </script>
</body>
</html>